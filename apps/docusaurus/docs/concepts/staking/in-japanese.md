---
title: "日本語 (In Japanese)"
---

import ThemedImage from '@theme/ThemedImage';
import useBaseUrl from '@docusaurus/useBaseUrl';

# ステーキング

# コンセンサス

:::tip コンセンサス
読み進める前に [Aptos Blockchain Deep Dive](../blockchain.md#consensus) のコンセンサスセクションを読むことを強くお勧めします。
:::

ブロックチェーンのような分散システムでは、トランザクションの実行は、台帳の状態を更新し、結果をストレージに永続化するというだけではありません。これらの結果がストレージに永続化され、台帳の状態が更新される前に、定足数のバリデータによってトランザクションの順番と結果について合意がなされる、すなわち、コンセンサスを得なければなりません。

十分なユーティリティ コインをステークする場合、つまりユーティリティ コインをエスクロー(訳注：第三者預託)に預けることができれば、誰でも Aptos コンセンサス形成に参加できます。 バリデータがコンセンサスプロセスに参加することを奨励するために、各バリデーターの投票の重みはバリデーターのステークしたコインの量に比例します。 その代わりに、バリデーターにはステークしたコイン量に比例した報酬が与えられます。 したがって、ブロックチェーンの性能はバリデーターの利益、つまり報酬と一致します。

:::note
今のところ、スラッシングは実装されていません。
:::

現在のオンチェーンデータは [`staking_config::StakingConfig`](https://api.mainnet.aptoslabs.com/v1/accounts/0x1/resource/0x1::staking_config::StakingConfig) で取得することができます。 設定のセットは [`staking_config.move`](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/configs/staking_config.move) で定義されます。

移行のこのドキュメントは、Aptos ブロックチェーン上でステーキングがどのように機能するかを説明します。 関連リソースについては、下部の[参考ドキュメント](#参考ドキュメント)をご覧ください。

# Aptosブロックチェーンでのステーキング

## Staking on the Aptos blockchain

Aptos ステーキングモジュールは、所有権を表現する能力を定義します。

:::tip 所有権
[stake.move](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/stake.move) で `OwnerCapability` の定義を参照してください。
:::

OwnerCapability リソースを使用して、ステークプールをコントロールできます。以下の 3 つの役割がサポートされています。

- 所有者
- オペレータ
- 投票者

この 所有者-オペレータ-投票者 モデルを使用すると、証券保管機関(エスクロー)は所有者の役割と Aptos ブロックチェーンへの出資を引き受け、Aptos のガバナンスに参加できます。 このモデルでは、資金を管理しているアカウントを他のアカウント (オペレータ、投票者) から分離することで、ステーキングサービスの責任の安全な委任が可能になります。
このセクションでは、ボブとアリスを例に、これがどのように機能するかを説明します。

### 所有者

オーナーは資金の所有者です。 たとえば、ボブが Aptos ブロックチェーン上にアカウントを作成したとします。これでボブは `OwnerCapability` リソースを持ちます。ボブは、自分のアカウントのオペレータ アドレスを信頼できるノードオペレータであるアリスのアカウントに割り当て、アリスをバリデータとして任命できます。

所有者として、

- ボブはステーキングに使用する資金を所有します。
- ボブのみが資金の追加、アンロック、引き出しができます。
- ボブのみがロックアップの期間を延長できます。
- ボブはノードオペレータであるアリスをいつでも他のノードオペレータへ変更できます。
- ボブはオペレータのコミッション比率を設定できます。
- 報酬はボブのアカウントへ振り込まれます。

### オペレータ

ノードオペレーターは資金の所有者によってバリデータノードを実行するように割り当てられ、所有者が設定したコミッションを受け取ります。所有者とオペレーターという 2 つの役割は、別個の実体でもよく、同じ実体でもよいです。 たとえば、アリス (オペレーター) は、資金の所有者であるボブの指示でバリデータノードを実行します。

オペレータとして、

- アリスはバリデータセットに参加や脱退ができます。
- バリデータとして、アリスはバリデーション機能を実行します。
- アリスには、コンセンサスキーとネットワークアドレスを変更する権限があります。 コンセンサスキーは、アリスがバリデータコンセンサスプロセスに参加する、つまりブロックを投票および提案するために使用されます。 この鍵が侵害された場合に備えて、アリスはこの鍵を変更 (ローテーション) することができます。
- ただし、アリスは資金の移動はできません (アリスが所有者である、つまり `OwnerCapability` リソースを持っていない限りは)。
- ステーカ (所有者)の報酬からオペレータコミッションが差し引かれ、オペレータアカウントへ振り込まれます。

### 投票者

所有者は投票者を指定できます。 これにより、有権者はガバナンスに参加できるようになります。 投票者は投票者キーを使用して、トランザクションのガバナンス投票に署名します。

:::tip ガバナンス
このドキュメントではステーキングについて説明します。所有者-投票者モードを使用して Aptos オンチェーンガバナンスに参加する方法については、[Governance](https://aptos.dev/concepts/governance) を参照してください。
:::

## Aptos ブロックチェーンにおけるバリデーション

エポック期間全体を通じて、次のイベントフローが複数回 (数千回) 発生します。

- バリデータのリーダーは、バリデータのパフォーマンス (バリデータが過去に投票したかどうかを含む) とステークによって決定されるバリデータの評判に基づく決定的な公式によって選択されます。 **このリーダーの選出は投票によっては行われません。**
- 選択されたリーダーは、前の提案で収集された定足数の投票とリーダーが提案した新しいブロックのトランザクション順序を含む提案を送信します。
- バリデータセットのすべてのバリデータは、新しいブロックに対するリーダーの提案に投票します。 合意に達すると、ブロックを完了できます。 したがって、コンセンサスを達成するための実際の投票リストは、バリデーター セット内のすべてのバリデーターのサブセットになります。 このバリデータのリーダーには報酬が与えられます。 **報酬はバリデータのリーダーにのみ与えられ、投票者バリデータには与えられません。**
- 上記のフローは、別のバリデータリーダーを選択して繰り返され、次の新しいブロックに対して手順が繰り返されます。報酬はエポックの終了時に与えられます。

## バリデータ状態とステーク状態

状態はバリデータとステークに対して定義されます。

- **バリデータの状態:** バリデータは、次の 4 つの状態のいずれかです。 さらに、バリデータは、inactive (バリデータセットにはない) 状態から、他の 3 つの状態のいずれかに移行できます。
  - 非アクティブ (inactive)
  - 保留中のアクティブ (pending_active)
  - アクティブ (active)
  - 保留中の非アクティブ (pending_inactive)
- **ステーク状態:** pending_inactive または active 状態のバリデータは、次の 4 つの状態のいずれかでステークを持つことができます。
  - 非アクティブ (inactive)
  - 保留中のアクティブ (pending_active)
  - アクティブ (active)
  - 保留中の非アクティブ (pending_inactive)
  これらのステーク状態は、ステークを追加または削除するバリデータセット内の既存のバリデータに適用されます。

### バリデータ状態

<ThemedImage
alt="Signed Transaction Flow"
sources={{
    light: useBaseUrl('/img/docs/validator-state.svg'),
    dark: useBaseUrl('/img/docs/validator-state-dark.svg'),
  }}
/>

There are two edge cases to call out:

注意すべきエッジケースが 2 つあります。

1. バリデータのステークが必要な[最小値](#ステークの最小値最大値)を下回った場合、そのバリデータはエポック変更中に active 状態から inactive 状態に直接移行します。 これはエポックの変更中にのみ発生します。
2. Aptos ガバナンスは、アクティブセットからバリデータを直接削除することもできます。**ガバナンス提案は常にエポック変更を引き起こすことに注意してください。**

### ステーク状態

ステークの状態はバリデータの状態よりも粒度が高いです。 追加のステークを追加したり、アクティブなバリデータからステークの一部を削除したりすることができます。

<ThemedImage
alt="Signed Transaction Flow"
sources={{
    light: useBaseUrl('/img/docs/stake-state.svg'),
    dark: useBaseUrl('/img/docs/stake-state-dark.svg'),
  }}
/>

### バリデータのルール

以下のルールは状態の変化に適用されます。

- 投票力はエポック境界でのみ変更 (増加または減少) できます。
- バリデータのコンセンサスキー、バリデータおよびバリデータのフルノードのネットワークアドレスは、エポック境界でのみ変更できます。
- pending_inactive なステークは、ロックアップが期限切れになるまで inactive に移行することはできません (したがって引き出し可能です)。
- アクティブなバリデータセット内のバリデータは、最小限必要なステークを下回るステークを持つことはできません。

## バリデータフロー

:::tip ステーキングプールの操作
以下のフローで実行するコマンドの正しい順序については、 [Staking pool operations](../../nodes/validator-node/operator/staking-pool-operations.md) を参照してください。
:::

1. 所有者は、`aptos stake create-staking-contract` によってステークプールを初期化します。
2. ステークを預ける準備ができたら（または、所有権機能と引き換えにステーキング サービスによって資金が割り当てられると）、所有者は`aptos stake add-stake`を呼び出します。
3. バリデータノードの準備ができたら、オペレータは `aptos node join-validator-set`を呼び出して、アクティブなバリデータセットに参加できます。 変更は次のエポックで有効になります。
4. バリデータは検証 (リーダーバリデータとしてブロックを提案) し、報酬を獲得します。ステークは一定期間（ガバナンスによって設定）自動的にロックされ、有効期限が切れると自動的に更新されます。
5. オペレーターがコンセンサスキーまたはバリデータネットワークアドレスを更新したい場合は、いつでも、`aptos node update-consensus-key` または `aptos node update-validator-network-addresses` を呼び出すことができます。ステークへの変更と同様、コンセンサスキーまたはバリデータネットワークアドレスへの変更は、次のエポックでのみ有効になります。
6. バリデータは、いつでもステークのロックを解除するようリクエストできます。 ただし、そのステークは、現在のロックアップが期限切れになった場合にのみ引き出し可能になります。 これは、最大でも固定ロックアップ期間と同じ長さになります。
7. 終了後、バリデータは、aptos ノードの `aptos node leave-validator-set` を呼び出してバリデーター セットを明示的に残すか、ステークが必要な最小値を下回った場合、エポックの終了時に削除されます。
8. バリデータは、手順 2 ～ 3 を再度実行することで、いつでもバリデータセットに再参加できます。
9. 所有者は、`aptos stake set-operator`を呼び出すことで、いつでもオペレーターを切り替えることができます。
10. 所有者は、`aptos stake set-delegated-voter`を呼び出すことで、いつでも委任投票者を切り替えることができます。

## バリデータセットへの参加

次の手順で Aptos ネットワーク上へバリデータノードとして参加することができます。

1. オペレータはバリデータノードを実行し、バリデータネットワークアドレスをオンチェーンで構成し、コンセンサスキーをローテーションします。
2. 所有者は Aptos コインの資金をステークとして預けるか、ステーキングサービスによって資金を割り当ててもらいます。 賭け金は最低額以上でなければなりません。
3. **バリデーターノードは、ステークプールが active になるまで同期できません。**
4. オペレータは検証を実行して報酬を獲得します。
5. ステークされたプールは、(Aptos ガバナンスによって設定された) 期間だけ自動的にロックされ、期限が切れると自動的に更新されます。 ロックアップ期間が終了するまでは、ステークされたコインを引き出すことはできません。 [stake.move#L728](https://github.com/aptos-labs/aptos-core/blob/00a234cc233b01f1a7e1680f81b72214a7af91a9/aptos-move/framework/aptos-framework/sources/stake.move#L728) を参照してください。
6. オペレータは、バリデータがアクティブになる前に、新しいエポックが開始するまで待つ必要があります。

:::tip バリデータセットへの参加
バリデーター セットに参加する方法の詳細な手順については、 [Joining Validator Set](../../nodes/validator-node/operator/connect-to-aptos-network.md#join-the-validator-set) を参照してください。
:::

### ステークの最小値・最大値

バリデータセットに参加するには、必要な最低額をステークする必要があります。さらに、最大ステーク額までしかステーキングできません。現在ステーキングに必要な最小値は100万APTトークン、最大値は5000万APTトークンです。

バリデーターセットに参加した後、現在のステーク額が（たとえば、報酬がステーキング額に追加されるなどの理由で）最大許容ステーク額を超えた場合、投票権と報酬はステークした額ではなく、最大許容ステーク額のみを使用して計算されます。

所有者はステークしたコインの一部を引き出し、残高を必要最小限以下にすることができます。 この場合、次のエポックの開始時に、ステークプールがバリデータセットから削除されます。

### 自動ドックアップ期間

バリデータセットに参加すると、 Aptos ガバナンスによって設定された期間、ステークは自動的にロックアップされます。

### 自動ロックアップ更新

ロックアップ期間が終了するとステークは自動的に更新されるため、引き続き検証して報酬を受け取ることができます。

### ステークのアンロック

いつでもステークのロックを解除するリクエストができます。ただし、現在のロックアップが期限切れになった場合にのみ、ステークされたコインを引き出すことができます。これは、最大でも固定ロックアップ期間と同じ長さになります。ステークされたコインが出金可能になるまで、報酬を獲得し続けることができます。

元本金額は、次のいずれかのアクションが発生すると更新されます。

1. オペレーターが [コミッションのロック解除をリクエスト](../../nodes/validator-node/operator/staking-pool-operations.md#requesting-commission) したとき
2. ステーカ（所有者）が資金を引き出したとき
3. ステーカ (所有者) がオペレータを切り替えたとき

ステーカがステークのロックを解除すると、コミッションのロックも解除されます。獲得したステーキング報酬の手数料全額がロック解除されます。これはロック解除ステーク額とは比例しません。コミッションは、ロックアップが終了した後か、`request commission`が二度目に呼び出されたときか、ステーカがロック解除されたステークを引き出した（分配した）ときにオペレーターに分配されます。

### ロックアップのリセット

期間が終了すると、ロックアップはネットワークによって自動的に更新されます。ただし、所有者は明示的にロックアップをリセットできます。

:::tip ガバナンスによる設定
ロックアップの期間は、 Aptos のガバナンス、つまり Aptos コミュニティのメンバーが投票する規約によって決定され、Aptos Labs のような特別な組織によって決定されるわけではありません。
:::

## エポック

Aptos ブロックチェーンのエポックは、バリデータによって多数のブロックが投票され、バリデータセットが更新され、報酬がバリデータに分配されるまでの時間として秒単位で定義されます。

:::tip メインネット上でのエポック
Aptos メインネットでのエポックは 7200 秒 (2時間)に設定されています。
:::

### エポック開始のトリガ

:::tip
全てのコードを見るには [Triggers at epoch boundary section of `stake.move`](https://github.com/aptos-labs/aptos-core/blob/256618470f2ad7d89757263fbdbae38ac7085317/aptos-move/framework/aptos-framework/sources/stake.move#L1036) を参照してください。
:::

各エポックの開始時に、次の主要なイベントがトリガーされます。

- バリデーター セットを更新し、保留中のアクティブなバリデータをアクティブなバリデータセットに追加し、保留中の非アクティブなバリデータをアクティブなバリデータセットから削除します。
- 保留中のアクティブステークをアクティブステークに移動し、保留中の非アクティブステークを非アクティブステークに移動します。
- 新しいエポックにおけるステーキングプールの投票権は、アクティブなステークの合計に更新されます。
- 新しいエポックで引き続きバリデータセット内に存在するバリデータのロックアップを自動的に更新します。
- バリデータセット内の各バリデータの投票権は、対応するステーキングプールの投票権になるように更新されます。
- 報酬は、前のエポックに参加したバリデーターに分配されます。

## 報酬

ステーキングの報酬は次のように計算されます。

1. 年率利回り（APY）`rewards_rate`、すなわち報酬は現在の賭け金の複利として発生します。
2. ステークされた資金量
3. Aptos ガバナンスにおける提案のパフォーマンス。

:::tip 報酬レート
`rewards_rate` は Aptos ガバナンスによって設定されます。 [Aptos ブロックチェーンにおけるバリデーション](#aptos-ブロックチェーンにおけるバリデーション) も参照してください。
:::

### 報酬の式

バリデーターへの報酬の計算に使用される式を以下に示します。

```
Reward = staked_amount * rewards_rate per epoch * (Number of successful proposals by the validator / Total number of proposals made by the validator)
```

### エポックごとに支払われる報酬

報酬はエポックごとに支払われます。現在のエポックの終了時にあなた (つまり、バリデータ) が獲得した報酬は、ステークされたコインに追加されます。次のエポック終了時の報酬は、増加したステーキング額 (つまり、元のステーキング額と追加の報酬) などに基づいて計算されます。

### 提案者のパフォーマンスに基づいた報酬

バリデータの報酬の計算には、バリデータの提案者のパフォーマンスが使用されます。バリデータ セットに入ると、すべてのエポックで提案できるようになります。提案が成功すればするほど、つまり提案が通過すればするほど、より多くの報酬を受け取ることができます。

報酬は**リーダーバリデータ**、つまり新しいブロックを提案するバリデータにのみ与えられ、新しいブロックに対するリーダーの提案に投票する**投票者-バリデータ**には与えられないことに注意してください。詳しくは [Aptos ブロックチェーンにおけるバリデーション](#aptos-ブロックチェーンにおけるバリデーション) を参照してください。

:::tip 報酬はロックアップ期間が適用されます
すべてのバリデータ報酬も、元のステーキング額に追加されるため、ロックアップ期間の対象となります。
:::

## バリデータセットからの脱退

:::tip
Move 言語の Aptos ステークモジュール [stake.move](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/stake.move) を参照してください。
:::

- 次の一連の関数を呼び出して、いつでもバリデータセットから脱退することができます。
  - `Stake::unlock` を呼び出してステーク額のロックを解除する。
  - `Stake::withdraw`を呼び出して次のエポックで賭け金を引き出すか、`Stake::leave_validator_set`を呼び出す。

## バリデータセットへの再参加

バリデーターセットを離脱したら、必要な最低額のステーク額を入金することで再参加できます。

## 参考ドキュメント

- [Current on-chain data](https://api.mainnet.aptoslabs.com/v1/accounts/0x1/resource/0x1::staking_config::StakingConfig)
- [Staking Pool Operations](https://aptos.dev/nodes/validator-node/operator/staking-pool-operations)
- [Delegation Pool Operations](https://aptos.dev/nodes/validator-node/operator/delegation-pool-operations)
- [Configuration file `staking_config.move`](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/configs/staking_config.move)
- [Contract file `staking_contract.move`](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/staking_contract.move) コミッションの要求も含む
- [All staking-related `.move files](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/framework/aptos-framework/sources)
