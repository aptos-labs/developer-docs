---
title: "トランザクションと状態"
---

import { Callout } from 'nextra/components'
import { ThemedImage } from '@components/index'

# トランザクションと状態

Aptosブロックチェーンは3種類のデータを保存します：

- **トランザクション**：トランザクションは、アカウントがブロックチェーン上で実行しようとする操作（資産の移転など）を表します。
- **状態**：（ブロックチェーン台帳の）状態は、トランザクションの実行結果の蓄積、すなわちすべての[リソース](resources.mdx)に格納された値を表します。
- [**イベント**](events.mdx)：トランザクションの実行によって公開される補助的なデータです。

<Callout type="info">
台帳の状態を変更できるのはトランザクションのみです。
</Callout>

## トランザクション

Aptosのトランザクションには、送信者のアカウントアドレス、送信者からの認証、Aptosブロックチェーン上で実行したい操作、トランザクションを実行するために送信者が支払う意思のあるガス量などの情報が含まれます。

### トランザクションの状態

トランザクションは以下のいずれかの状態で終了する可能性があります：

- ブロックチェーンにコミットされ実行された状態。これは成功したトランザクションとみなされます。
- ブロックチェーンにコミットされたが中断された状態。中断コードは、トランザクションの実行が失敗した理由を示します。
- ガス不足、無効なトランザクション形式、不正なキーなどの検証チェックにより、トランザクション送信時に破棄された状態。
- トランザクション送信後、実行試行前に破棄された状態。これは、タイムアウトや他のトランザクションがアカウントに影響を与えたことによるガス不足が原因である可能性があります。

コミットされたトランザクションについては、送信者のアカウントにガス料金が請求されます。

トランザクション送信時、送信者は送信の成功または検証失敗の理由について通知されます。

正常に送信されたものの最終的に破棄されたトランザクションは、アクセス可能なAptosノードやAptosネットワーク内で状態が表示されない場合があります。ユーザーは同じトランザクションを再送信して、トランザクションを再検証することができます。送信ノードがこのトランザクションがまだ有効であると判断した場合、同一のトランザクションが送信されたことを示すエラーを返します。

送信者は、ガスコストをわずかに増やすことで、下流でトランザクションが破棄される原因となっていた問題に対処し、進行を促すことができます。

<Callout type="info">
Aptosトランザクションのライフサイクルについての包括的な説明は、[Aptosブロックチェーンの詳細](blockchain-deep-dive.mdx)をご覧ください。
</Callout>

### トランザクションの内容

ブロックチェーン上の署名付きトランザクションには、以下の情報が含まれます：

- **署名**：送信者はデジタル署名を使用して、トランザクションに署名したことを証明します（認証）。
- **送信者アドレス**：送信者の[アカウントアドレス](accounts.mdx#account-address)。
- **送信者の公開鍵**：トランザクションの署名に使用された秘密認証鍵に対応する公開認証鍵。
- **ペイロード**：Aliceの代わりに実行するアクションまたはアクションのセットを示します。Moveファンクションの場合、チェーン上のMoveバイトコードを直接呼び出します。あるいは、ピアツーピアの[トランザクションスクリプト](../glossary.mdx#transaction-script)であるMoveバイトコードの場合もあります。また、ファンクションまたはスクリプトへの入力のリストも含まれます。この例では、AliceのアカウントからBobのアカウントへAptos Coinの量を転送するファンクション呼び出しで、Aliceのアカウントはトランザクションの送信によって暗示され、Bobのアカウントと金額はトランザクションの入力として指定されます。
- [**ガスユニット価格**](../glossary.mdx#gas-unit-price)：トランザクションを実行するためにガス1単位あたりに支払う意思のある金額。これは[オクタ](../glossary.mdx#octa)で表されます。
- [**最大ガス量**](../glossary.mdx#maximum-gas-amount)：送信者がこのトランザクションに支払う意思のある最大ガス量（APT）。ガス料金は、計算とIOによってカバーされる基本ガスコストにガス価格を掛けたものです。ガスコストには、APT固定価格のストレージモデルによるストレージも含まれます。これは[オクタ](../glossary.mdx#octa)で表されます。
- **ガス価格**（指定されたガス単位で）：トランザクションを実行するためにガス1単位あたりに支払う意思のある金額です。[ガス](gas-txn-fee.mdx)は計算とストレージの支払い方法です。ガス単位は、実世界の価値を持たない抽象的な計算の測定単位です。
- **最大ガス量**：[最大ガス量](gas-txn-fee.mdx#specifying-gas-fees-within-a-transaction)は、トランザクションが消費を許可される最大ガス単位です。
- **シーケンス番号**：実行時に送信者のアカウントの[シーケンス番号](accounts.mdx#account-sequence-number)と等しくなければならない符号なし整数です。
- **有効期限**：トランザクションが無効になる（期限切れになる）タイムスタンプです。

### トランザクションペイロードの種類

与えられたトランザクション内で、最も一般的な2種類のペイロードには以下が含まれます：

- エントリーポイント
- [スクリプト（ペイロード）](../../build/smart-contracts/scripts.mdx)

現在、SDK [Python](../../build/sdks/python-sdk.mdx)と[Typescript](../../build/sdks/ts-sdk.mdx)は両方をサポートしています。このガイドでは、`coin::transfer`や`aptos_account::create_account`など、多くのエントリーポイントを示しています。

Aptosブロックチェーン上のすべての操作は、エントリーポイント呼び出しを介して利用可能であるべきです。エントリーポイントを呼び出す複数のトランザクションを連続して送信することもできますが、そのような操作の多くは単一のトランザクションから原子的に呼び出される方が有益かもしれません。スクリプトペイロードトランザクションは、任意のモジュール内で定義された任意のエントリーポイントまたはパブリック関数を呼び出すことができます。

<Callout type="info">
有効なトランザクションの生成については、[初めてのトランザクション](../../build/guides/first-transaction.mdx)のチュートリアルをご覧ください。
</Callout>

<Callout type="info">
Aptos REST APIは、JSONからBCSエンコードされたトランザクションを生成することをサポートしています。これは急速なプロトタイピングに便利ですが、トランザクションを生成するフルノードに多くの信頼を置くことになるため、メインネットでの使用には注意が必要です。
</Callout>

## 状態

Aptosブロックチェーンの台帳状態、またはグローバル状態は、Aptosブロックチェーン内のすべてのアカウントの状態を表します。ブロックチェーン内の各バリデーターノードは、任意のトランザクションを実行するために、グローバル状態の最新バージョンを知っている必要があります。

誰でもAptosブロックチェーンにトランザクションを送信して台帳状態を変更することができます。トランザクションの実行時に、トランザクション出力が生成されます。トランザクション出力には、**ライトセット**と呼ばれる台帳状態を操作するための0個以上の操作、結果として生成されるイベントのベクター、消費されたガス量、実行されたトランザクションのステータスが含まれます。

### 証明

Aptosブロックチェーンは、ブロックチェーンデータの信頼性と正確性を検証するために証明を使用します。

Aptosブロックチェーン内のデータはネットワーク全体で複製されます。各バリデーターとフルノードの[ストレージ](validator-nodes.mdx#storage)は、合意された取引のブロックとその実行結果をデータベースに永続化する責任があります。

ブロックチェーンは、常に成長する[マークルツリー](../glossary.mdx#merkle-trees)として表現され、ツリーに追加される各リーフは、ブロックチェーンによって実行された単一のトランザクションを表します。

ブロックチェーンによって実行されるすべての操作とすべてのアカウント状態は、暗号的に検証することができます。これらの暗号的な証明により、以下が保証されます：

- バリデーターノードが状態に合意している。
- クライアントはデータを受け取るエンティティを信頼する必要がない。例えば、クライアントがアカウントから最後の**n**個のトランザクションを取得する場合、証明によってレスポンスにトランザクションが追加、省略、または変更されていないことを証明できます。クライアントはまた、アカウントの状態を照会したり、特定のトランザクションが処理されたかどうかを尋ねたりすることもできます。

### バージョン管理されたデータベース

台帳状態は、システムが実行したトランザクション数に対応する符号なし64ビット整数を使用してバージョン管理されています。このバージョン管理されたデータベースにより、バリデーターノードは以下のことができます：

- 最新バージョンの台帳状態に対してトランザクションを実行する。
- 現在および過去のバージョンの両方で、台帳履歴に関するクライアントのクエリに応答する。

## トランザクションによる台帳状態の変更

<ThemedImage
  alt="署名付きトランザクションのフロー"
  sources={{
    light: '/docs/transactions-and-state.svg',
    dark: '/docs/transactions-and-state-dark.svg',
  }}
/>

上の図は、トランザクションT<sub>_i_</sub>の実行によって、Aptosブロックチェーンの状態がS<sub>_i-1_</sub>からS<sub>_i_</sub>に変化する様子を示しています。

図の中で：

- アカウント**A**と**B**：AptosブロックチェーンにおけるAliceとBobのアカウントを表します。
- **S<sub>_i-1_</sub>**：ブロックチェーンの(_i-1_)番目の状態を表します。この状態では、AliceのアカウントAの残高は110 APT（Aptosコイン）で、BobのアカウントBの残高は52 APTです。
- **T<sub>_i_</sub>**：これはブロックチェーン上で実行された_i_番目のトランザクションです。この例では、AliceがBobに10 APTを送金することを表しています。
- **Apply()**：これは、特定の初期状態と特定のトランザクションに対して常に同じ最終状態を返す決定論的な関数です。ブロックチェーンの現在の状態が**S<sub>_i-1_</sub>**で、トランザクション**T<sub>_i_</sub>**が状態**S<sub>_i-1_</sub>**に対して実行される場合、ブロックチェーンの新しい状態は常に**S<sub>_i_</sub>**になります。Aptosブロックチェーンは、決定論的な実行関数**Apply()**を実装するために[Move言語](../../build/smart-contracts/book/SUMMARY.mdx)を使用します。
- **S<sub>_i_</sub>**：これはブロックチェーンの_i_番目の状態です。トランザクション**T<sub>_i_</sub>**がブロックチェーンに適用されると、新しい状態**S<sub>_i_</sub>**が生成されます（**Apply(S<sub>_i-1_</sub>, T<sub>_i_</sub>)**を**S<sub>_i-1_</sub>**と**T<sub>_i_</sub>**に適用した結果）。これにより、Aliceのアカウント残高が10減少して100 APTになり、Bobのアカウント残高が10増加して62 APTになります。新しい状態**S<sub>_i_</sub>**はこれらの更新された残高を示しています。
