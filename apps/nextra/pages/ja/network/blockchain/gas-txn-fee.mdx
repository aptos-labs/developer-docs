---
title: "ガスとストレージ手数料"
---

import { Callout } from 'nextra/components';

# ガスとストレージ手数料

Aptosブロックチェーン上でのトランザクション実行には手数料が必要です。現在、この手数料は2つの要素で構成されています：

1. 実行とIO費用

- トランザクションの処理やメインネットの分散ネットワーク全体での検証済みレコードの伝播など、一時的な計算リソースの使用をカバーします。
- ネットワークの負荷に応じて価格が変動するガスユニットで測定されます。これにより、ネットワークの混雑が少ない時は実行とIOの費用を低く抑えることができます。
- このガスの部分は、トランザクションの実行時に永久に焼却されます。

2. ストレージ手数料

- 検証済みレコードを分散ブロックチェーンストレージに永続的に保存するコストをカバーします。
- 固定APT価格で測定されるため、ガスユニット価格がネットワークの一時的な負荷によって変動しても、永続的なストレージコストは安定しています。
- 割り当てられたストレージスロットが削除されると、ストレージ手数料は返金されます。現在、ネットワークは状態ストレージスロットの存続期間中に支払われたストレージ手数料の全額を返金するように設定されています。
- システムの実装をシンプルに保つため、このガスの部分は焼却され、返金時に再度発行されます。

<Callout type="info">
概念的に、この手数料は家庭の電気料金や水道料金の支払い方と非常によく似ています。
</Callout>

## ガスの単位

トランザクションは、その内容に応じてシンプルで安価なものから複雑なものまでさまざまです。Aptosブロックチェーンでは、**ガスユニット**は計算の実行やストレージへのアクセスなど、一時的なリソースの消費の基本単位を表します。後者は、そのような操作の長期的なストレージの側面と混同すべきではありません。これは別途ストレージ手数料でカバーされます。

ガス手数料の種類と利用可能な最適化の詳細については、[ベースガスの仕組み](base-gas.mdx)をご覧ください。

<Callout type="info">
👉 **ガスユニット**は、コインなどの特定のアイテムに関連付けられていない無次元の数値または単位で、整数として表現されます。トランザクションで消費される総ガスユニットは、トランザクションの複雑さに依存します。一方、**ガス価格**はAptosブロックチェーンのネイティブコインである[APT](../glossary.mdx#APT)とその下位単位である[Octa](../glossary.mdx#octa)で表現されます。また、Aptosブロックチェーンに提出されるトランザクションの形式については[トランザクションと状態](txns-states.mdx)をご覧ください。
</Callout>

## 手数料明細

Aptos Framework 1.7のリリース以降、手数料の請求と返金の内訳は、構造体`0x1::transaction_fee::FeeStatement`で表されるモジュールイベントとして発行されます。

```move filename="transaction_fee.move"
#[event]
#[event]
/// トランザクションの手数料の請求と返金の内訳。
/// 構造は以下の通り：
///
/// - 正味の請求または返金（ステートメントには含まれない）
///    - 合計請求額：total_charge_gas_units、オンチェーンの`TransactionInfo`の`gas_used`と一致。
///      これは以下のサブ項目の合計です。内部ガス単位と外部ガス単位の変換、およびネイティブトークンと
///      ガス単位の変換で精度が失われる可能性があるため、数値が完全に一致しない場合があります。
///      -- この数値が最終的な請求額であり、内訳は情報提供のみを目的としています。
///        - 実行のガス請求（CPU時間）：`execution_gas_units`
///        - IOのガス請求（ストレージランダムアクセス）：`io_gas_units`
///        - ストレージ手数料の請求（ストレージ容量）：`storage_fee_octas`、
///          `total_charge_gas_unit`に含まれ、この数値はトランザクションでユーザーが
///          指定した`gas_unit_price`に従ってガス単位に変換されます。
///    - ストレージ削除の返金：`storage_fee_refund_octas`、これは`gas_used`や
///      `total_charge_gas_units`には含まれず、正味の請求/返金は
///      `total_charge_gas_units` * `gas_unit_price` - `storage_fee_refund_octas`で計算されます。
///
struct FeeStatement has drop, store {
    /// Total gas charge.
    total_charge_gas_units: u64,
    /// Execution gas charge.
    execution_gas_units: u64,
    /// IO gas charge.
    io_gas_units: u64,
    /// Storage fee charge.
    storage_fee_octas: u64,
    /// Storage fee refund.
    storage_fee_refund_octas: u64,
}
```

## ガス価格とトランザクションの優先順位付け

Aptosネットワークでは、Aptosガバナンスが絶対的な最低ガス単価を設定します。しかし、特定のガス単価のトランザクションがどれだけ早く処理されるかは市場が決定します。例えば、[Ethereum Gas Tracker](https://etherscan.io/gastracker)では、Ethereumのガス価格の市場価格の動きが表示されます。

現在の市場価格よりも高いガス単価を指定することで、より大きな処理手数料を支払うことによってブロックチェーン上のトランザクションの優先度レベルを**上げる**ことができます。コンセンサスの一部として、リーダーが次のブロックの提案の一部としてメンプールからトランザクションを選択する際、より高いガス単価のトランザクションを優先的に選択します。ただし、より高いガス手数料は次のブロックのトランザクション選択のみを優先することに注意してください。

ただし、ブロック内でのトランザクションの実行順序はシステムによって決定されます。この順序は、競合パターンを考慮して並列実行をより効率的にする[トランザクションシャッフリング](https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-27.md)に基づいています。ほとんどの場合これは不要ですが、ネットワークが負荷状態にある場合、この対策によりトランザクションがより迅速に処理されることを保証できます。詳細については、[シミュレーションによるガス消費量の見積もり](#estimating-gas-consumption-via-simulation)の`gas_unit_price`エントリをご覧ください。

<Callout type="warning">
👉 ガス単価を上げる場合、同じアカウントの未確定（未コミット）トランザクションがある場合は、それらのトランザクションすべてをより高いガス単価で再送信する必要があります。これは、同じアカウント内のトランザクションは常にシーケンス番号を尊重する必要があるため、実質的にガス単価の高いトランザクションは、未確定のトランザクションがブロックに含まれた後でのみ優先度が上がるためです。
</Callout>

## トランザクション内でのガス手数料の指定

トランザクションがAptosブロックチェーンに送信される際、トランザクションには以下の必須のガスフィールドが含まれている必要があります：

- `max_gas_amount`: トランザクション送信者がトランザクションの実行に支払う意思のある最大ガス単位数。これにより、トランザクションが消費できる計算リソースとストレージリソースの最大値が決定されます。
- `gas_price`: トランザクション送信者が支払う意思のあるガス単位あたりの価格。[Octa](../glossary.mdx#Octa)で表されます。

  トランザクション実行中、以下の式で表される総ガス量：

  ```text
  (消費された総実行ガス単位) + (消費された総ストレージガス単位)
  ```
  は`max_gas_amount`を超えてはいけません。超えた場合、トランザクションの実行は中止されます。

クライアントに請求されるトランザクション手数料は、最大で`gas_price * max_gas_amount`となります。

## ガバナンスによって設定されるガスパラメータ

以下のガスパラメータはAptosガバナンスによって設定されます。

<Callout type="info">
これらのオンチェーンガスパラメータは、Aptosブロックチェーン上の`0x1::gas_schedule::GasScheduleV2`に公開されています。
</Callout>

- `txn.maximum_number_of_gas_units`: 使用できるガス単位の最大数（これはトランザクションのガスパラメータ`max_gas_amount`に設定できる最大値です）。これは、動的な価格調整によって支払い意思のある総額を超えないようにするためです。
- `txn.min_transaction_gas_units`: 使用できるガス単位の最小数。トランザクションの`max_gas_amount`値はこのパラメータの値より大きく設定する必要があります。

また、カテゴリごとにいくつかのグローバルな制限も存在します：

- `txn.max_execution_gas`: トランザクションが実行に使用できるガス単位の最大数。
- `txn.max_io_gas`: トランザクションがIOに使用できるガス単位の最大数。
- `txn.max_storage_fee`: トランザクションが永続ストレージに使用できるAPTの最大額。
これらの制限により、カテゴリ間の分離が可能となり、乱用を心配することなく`txn.maximum_number_of_gas_units`を寛容に設定できます。

## ストレージ手数料の計算

トランザクションのストレージ手数料は、グローバル状態で新しく割り当てられたスロットの数と、既存のスロットのサイズ増加に応じて課金されます。

価格変更や、過去の「無料枠」以下のスロットサイズに対して支払いがなかったレガシースロットに関しては、いくつかの微妙な点があります。詳細については[AIP-65](https://github.com/aptos-foundation/AIPs/blob/main/aips/aip-65.md#specification)を参照してください。

また、後方互換性の理由により、トランザクションの総ストレージ手数料は現在、総`gas_used`の一部としてクライアントに提示されることに注意してください。つまり、同じトランザクションでもガス単価によってこの金額が変動する可能性があります。

例を示します。実行とIOで`100`ガス単位、ストレージ手数料で`5000` [Octa](../glossary.mdx#Octa)かかるトランザクションがあるとします。ネットワークは以下のように表示します：

- ガス単価が`100`の場合、`100 + 5000 / 100 = 150`ガス単位
- ガス単価が`200`の場合、`100 + 5000 / 200 = 125`ガス単位

この混乱を招く可能性があることは認識しており、将来的にはこれらを別項目として表示する予定です。ただし、トランザクション出力形式とダウンストリームクライアントの変更が必要となるため、実現までしばらくお待ちください。

## ストレージ削除の返金の計算

トランザクションが状態項目を削除する場合、解放されたストレージスロットに対してトランザクション支払者に返金が発生します。現在は全額返金が行われます - つまり、スロットとアイテムのバイトに対してその存続期間中に支払われたすべてのストレージ手数料が返金されます。

返金額はAPTで表示され、ガス単位には換算されず、総`gas_used`にも含まれません。代わりに、この返金額は[`FeeStatement`](#the-fee-statement)の`storage_fee_refund_octas`フィールドで具体的に詳述されます。その結果、トランザクションの支払者のAPT残高への正味の影響は`gas_used * gas_unit_price - storage_refund`で決定されます。結果が正の場合はアカウント残高から差し引かれ、負の場合は入金されます。

## 例

### 例1：アカウント残高とトランザクション手数料

**送信者のアカウントには、トランザクション手数料を支払うのに十分な残高が必要です。**

例えば、アカウントからすべての資金を送金して、トランザクション手数料を支払う残高がない場合。このような場合、Aptosブロックチェーンはトランザクションが失敗することを通知し、送金も成功しません。

### 例2：トランザクション金額とトランザクション手数料

**トランザクション手数料は、トランザクション内の送金額とは独立しています。**

例えば、トランザクションAでは1つのアカウントから別のアカウントに1000コインを送金します。トランザクションAと同じガスフィールド値を持つ2番目のトランザクションBでは、1つのアカウントから別のアカウントに100,000コインを送金します。トランザクションAとBがほぼ同時に送信されたと仮定すると、トランザクションAとBのガスコストはほぼ同じになります。

## シミュレーションによるガス消費量の見積もり

トランザクションのガス使用量は、ここで説明するようにチェーン上でトランザクションをシミュレーションするか、Aptos CLIのガスプロファイリング機能を使用してローカルで見積もることができます。シミュレートされたトランザクションの結果は、シミュレーション時のブロックチェーンの**正確な**状態で必要な**正確な**量を表します。これらのガス単位使用量は、チェーンの状態に基づいて変化する可能性があります。このため、シミュレーションから得られる量はあくまで見積もりであり、max gas amountを設定する際には、快適さと過去の動作に基づいて適切な余裕を含める必要があります。max gas amountを低く設定しすぎると、トランザクションが中止され、消費されたガス分がアカウントに請求されます。

チェーン上でトランザクションをシミュレートするには、[`SimulateTransaction`](https://api.devnet.aptoslabs.com/v1/spec#/operations/simulate_transaction) APIを使用します。このAPIは、実行予定のトランザクションと全く同じものを実行します。

トランザクションをローカルでシミュレートするには、Aptos CLIに統合されているガスプロファイラーを使用します。
これにより、トランザクションの正確なガス使用量を理解するためのウェブベースのレポートが生成されます。
詳細については[ガスプロファイリング](../../build/cli/working-with-move-contracts/local-simulation-benchmarking-and-gas-profiling.mdx#gas-profiling)を参照してください。

<Callout type="info">
トランザクションで提供される`Signature`はすべてゼロでなければならないことに注意してください。これは、有効な署名が使用されるのを防ぐためです。
</Callout>

トランザクションをシミュレートするには、2つのフラグがあります：

1. `estimate_gas_unit_price`: このフラグは、[`estimate_gas_price`](https://api.devnet.aptoslabs.com/v1/spec#/operations/estimate_gas_price) APIと同じアルゴリズムを使用してトランザクションのガス単価を見積もります。
2. `estimate_max_gas_amount`: このフラグは使用可能な最大のガスを見つけ、トランザクションをシミュレートして実際の`gas_used`を教えてくれます。

### シミュレーションのステップ

トランザクションの正しいガス量を見つけるためのシミュレーションステップは以下の通りです：

1. `estimate_gas_unit_price`と`estimate_max_gas_amount`の両方を`true`に設定してシミュレーションでガスを見積もります。
2. 返されたトランザクションの`gas_unit_price`を新しいトランザクションの`gas_unit_price`として使用します。
3. 返されたトランザクションの`gas_used * gas_unit_price`の値をトランザクションコストの**下限**として見ます。
4. コストの上限を計算するには、返されたトランザクションの`max_gas_amount`と`gas_used * 安全係数`の**最小値**を取ります。CLIでは`安全係数`として`1.5`が使用されています。この値を送信したいトランザクションの`max_gas_amount`として使用します。トランザクションのコストの**上限**は`max_gas_amount * gas_unit_price`、つまりトランザクションの送信者に請求される最大額であることに注意してください。
5. この時点で、トランザクションを送信するための`gas_unit_price`と`max_gas_amount`が以下のように得られます：
   1. シミュレートされたトランザクションから返された`gas_unit_price`。
   2. `gas_used` * `安全係数`またはトランザクションからの`max_gas_amount`の最小値として`max_gas_amount`。
6. トランザクションの優先順位を上げたり下げたりする必要がある場合は、トランザクションの`gas_unit_price`を調整します。優先順位を上げるには値を増やし、下げるには値を減らします。

<Callout type="info">
優先順位付けは`gas_unit_price`のバケットに基づいています。バケットは[`mempool_config.rs`](https://github.com/aptos-labs/aptos-core/blob/30b385bf38d3dc8c4e8ee0ff045bc5d0d2f67a85/config/src/config/mempool_config.rs#L8)で定義されています。現在のバケットは`[0, 150, 300, 500, 1000, 3000, 5000, 10000, 100000, 1000000]`です。したがって、`gas_unit_price`が150と299の場合、優先順位はほぼ同じになります。
</Callout>

<Callout type="info">
`安全係数`は実行とIOに関連する変更のみを考慮していることに注意してください。予期しないストレージスロットの作成は十分にカバーされない可能性があります。
</Callout>
