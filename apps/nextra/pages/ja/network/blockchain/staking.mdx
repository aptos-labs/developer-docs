---
title: "ステーキング"
---

import { Callout } from "nextra/components";
import { ThemedImage } from '@components/index'

# ステーキング

<Callout type="info">
先に進む前に、[Aptosブロックチェーンの詳細](blockchain-deep-dive.mdx#consensus)のコンセンサスセクションをお読みいただくことを強くお勧めします。
</Callout>

ブロックチェーンのような分散システムでは、トランザクションの実行は、台帳の状態を更新してその結果をストレージに永続化することとは異なります。これらの結果がストレージに永続化され、台帳の状態が更新される前に、トランザクションの順序とその実行結果について、バリデータの定足数による合意（コンセンサス）が必要です。

十分な量のユーティリティコインをステーク（エスクローに預け入れ）すれば、誰でもAptosのコンセンサスプロセスに参加できます。バリデータのコンセンサスプロセスへの参加を促すため、各バリデータの投票の重みはバリデータのステーク量に比例します。その見返りとして、バリデータはステーク量に比例した報酬を受け取ります。したがって、ブロックチェーンのパフォーマンスはバリデータの利益（報酬）と一致します。

<Callout type="info">
現在、スラッシングは実装されていません。
</Callout>

現在のオンチェーンデータは[`staking_config::StakingConfig`](https://api.mainnet.aptoslabs.com/v1/accounts/0x1/resource/0x1::staking_config::StakingConfig)で確認できます。設定セットは[`staking_config.move`](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/configs/staking_config.move)で定義されています。

このドキュメントの残りの部分では、Aptosブロックチェーンでのステーキングの仕組みについて説明します。関連リソースについては、下部の[サポート文書](#supporting-documentation)を参照してください。

## Aptosブロックチェーンでのステーキング

以下は、Aptosブロックチェーンでのステーキングの仕組みを示すフロー図の概要です。概要に続くセクションで詳細を説明します。

<ThemedImage
  alt="ステーキングフロー"
  sources={{
    light: '/docs/staking-light.svg',
    dark: '/docs/staking-dark.svg',
  }}
/>

Aptosのステーキングモジュールは、所有権を表すケイパビリティを定義します。

<Callout type="info">
[stake.move](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/stake.move)で定義されている`OwnerCapability`を参照してください。
</Callout>

`OwnerCapability`リソースはステークプールを制御するために使用できます。3つのペルソナがサポートされています：

- オーナー
- オペレーター
- 投票者

このオーナー・オペレーター・投票者モデルを使用することで、カストディアンはオーナーのペルソナを引き受け、Aptosブロックチェーンでステーキングを行い、Aptosのガバナンスに参加することができます。このモデルは、資金を管理するアカウントを他のアカウント（オペレーター、投票者）から分離するため、委任とステーキングサービスの構築を可能にし、責任の安全な委任を可能にします。

このセクションでは、BobとAliceを例に使用して、その仕組みを説明します。

### オーナー

オーナーは資金の所有者です。例えば、BobがAptosブロックチェーンでアカウントを作成します。これでBobは`OwnerCapability`リソースを持ちます。Bobは、信頼できるノードオペレーターであるAliceをバリデータとして任命するために、自分のアカウントのオペレーターアドレスをAliceのアカウントに割り当てることができます。

オーナーとして：

- Bobはステーキングに使用される資金を所有します。
- 資金の追加、ロック解除、引き出しができるのはBobだけです。
- ロックアップ期間を延長できるのはBobだけです。
- BobはノードオペレーターのAliceを、希望する他のノードオペレーターにいつでも変更できます。
- Bobはオペレーターの手数料の割合を設定できます。
- 報酬はBob（オーナー）のアカウントに入金されます。

### オペレーター

ノードオペレーターは、資金のオーナーによってバリデータノードを運営するために割り当てられ、オーナーが設定した手数料を受け取ります。オーナーとオペレーターの2つのペルソナは、別々の主体でも同じ主体でもかまいません。例えば、Alice（オペレーター）は、資金のオーナーであるBobの要請でバリデータノードを運営します。

オペレーターとして：

- Aliceはバリデータセットへの参加または離脱の権限のみを持ちます。
- バリデータとして、Aliceはバリデーション機能を実行します。
- Aliceはコンセンサスキーとネットワークアドレスを変更する権限を持ちます。コンセンサスキーは、Aliceがバリデータのコンセンサスプロセス（投票やブロックの提案）に参加するために使用されます。このキーが漏洩した場合に備えて、Aliceはこのキーを変更（「ローテーション」）することができます。
- ただし、Alice（オーナー、つまり`OwnerCapability`リソースを持っている場合を除く）は資金を移動することはできません。
- オペレーターの手数料はステーカー（オーナー）の報酬から差し引かれ、オペレーターのアカウントに入金されます。

### 投票者

オーナーは投票者を指定することができます。これにより、投票者はガバナンスに参加することができます。投票者は投票者キーを使用してトランザクションのガバナンス投票に署名します。

<Callout type="info">
このドキュメントではステーキングについて説明しています。オーナー・投票者モデルを使用してAptosのオンチェーンガバナンスに参加する方法については、[ガバナンス](governance.mdx)を参照してください。
</Callout>

## Aptosブロックチェーンでのバリデーション

エポック期間中、以下のイベントの流れが何度も（数千回）発生します：

- バリデータリーダーは、バリデータのパフォーマンス（過去の投票の有無を含む）とステークに基づいて決定される評価に基づく決定論的な式によって選出されます。**このリーダー選出は投票によって行われるものではありません。**
- 選出されたリーダーは、前回の提案に対する定足数の投票と、新しいブロックに対するリーダーが提案する取引の順序を含む提案を送信します。
- バリデータセットのすべてのバリデータが、新しいブロックに対するリーダーの提案に投票します。コンセンサスが得られると、ブロックを確定することができます。したがって、コンセンサスを達成するための実際の投票リストは、バリデータセット内のすべてのバリデータのサブセットです。このリーダーバリデータは報酬を受け取ります。**報酬は投票バリデータではなく、リーダーバリデータにのみ与えられます。**
- 上記の流れは、別のバリデータリーダーの選出と次の新しいブロックのためのステップの繰り返しで続きます。報酬はエポックの終わりに支払われます。

## バリデータの状態とステークの状態

バリデータとステークに対して状態が定義されています。

- **バリデータの状態：** バリデータは以下の4つの状態のいずれかになります。また、バリデータは非アクティブ（バリデータセットのどこにも追跡されていない）状態から他の3つの状態のいずれかに移行できます：
  - 非アクティブ
  - アクティブ待ち
  - アクティブ
  - 非アクティブ待ち
- **ステークの状態：** 非アクティブ待ちまたはアクティブ状態のバリデータは、以下の4つの状態のいずれかにステークを持つことができます：

  - 非アクティブ
  - アクティブ待ち
  - アクティブ
  - 非アクティブ待ち

  これらのステーク状態は、バリデータセット内の既存のバリデータがステークを追加または削除する場合に適用されます。

### バリデータの状態

<ThemedImage
  alt="署名付きトランザクションフロー"
  sources={{
    light: '/docs/validator-state.svg',
    dark: '/docs/validator-state-dark.svg',
  }}
/>

注意すべき2つのエッジケースがあります：

1. バリデータのステークが必要な[最小額](#minimum-and-maximum-stake)を下回った場合、そのバリデータはエポック変更時にアクティブ状態から直接非アクティブ状態に移行します。これはエポック変更時にのみ発生します。
2. Aptosガバナンスは、アクティブセットから直接バリデータを削除することもできます。**ガバナンス提案は常にエポック変更をトリガーすることに注意してください。**

### ステークの状態

ステークの状態は、バリデータの状態よりも細かい粒度を持ちます。アクティブなバリデータに追加のステークを追加したり、ステークの一部を削除したりすることができます。

<ThemedImage
  alt="署名付きトランザクションフロー"
  sources={{
    light: '/docs/stake-state.svg',
    dark: '/docs/stake-state-dark.svg',
  }}
/>

### バリデータのルール

状態の変更時には以下のルールが適用されます：

- 投票力はエポックの境界でのみ変更（増加または減少）できます。
- バリデータのコンセンサスキーおよびバリデータとバリデータフルノードのネットワークアドレスは、エポックの境界でのみ変更できます。
- 非アクティブ待ちのステークは、ロックアップが期限切れになるまで非アクティブ（つまり引き出し可能）に移行できません。
- アクティブなバリデータセット内のバリデータは、必要な最小ステーク未満のステークを持つことはできません。

## バリデータのフロー

<Callout type="info">
以下のフローに対する正しいコマンドの順序については、[ステーキングプールの操作](../nodes/validator-node/connect-nodes/staking-pool-operations.mdx)を参照してください。
</Callout>

1. オーナーは`aptos stake create-staking-contract`でステークプールを初期化します。
2. オーナーがステークを預け入れる準備ができた（または所有権能力と引き換えにステーキングサービスから資金を割り当てられた）場合、オーナーは`aptos stake add-stake`を呼び出します。
3. バリデータノードの準備ができたら、オペレーターは`aptos node join-validator-set`を呼び出してアクティブなバリデータセットに参加できます。変更は次のエポックで有効になります。
4. バリデータはバリデーション（リーダーバリデータとしてブロックを提案）を行い、報酬を得ます。ステークは自動的に固定期間（ガバナンスによって設定）ロックアップされ、期限切れ時に自動的に更新されます。
5. オペレーターは任意の時点で、コンセンサスキーまたはバリデータネットワークアドレスを更新したい場合、`aptos node update-consensus-key`または`aptos node update-validator-network-addresses`を呼び出すことができます。ステークの変更と同様に、コンセンサスキーまたはバリデータネットワークアドレスの変更は次のエポックでのみ有効になります。
6. バリデータはいつでもステークのロック解除を要求できます。ただし、現在のロックアップが期限切れになるまで、ステークは引き出し可能になりません。これは最大でも固定ロックアップ期間と同じ長さです。
7. 退出後、バリデータは`aptos node leave-validator-set`を呼び出してバリデータセットを明示的に離脱するか、ステークが最小必要額を下回った場合、エポック終了時に削除されます。
8. バリデータは、ステップ2-3を再度実行することで、いつでもバリデータセットに再参加できます。
9. オーナーは`aptos stake set-operator`を呼び出すことで、いつでもオペレーターを切り替えることができます。
10. オーナーは`aptos stake set-delegated-voter`を呼び出すことで、いつでも指定された投票者を切り替えることができます。

## バリデータセットへの参加

Aptosネットワークでバリデータノードとして参加する方法は以下の通りです：

1. オペレーターはバリデータノードを実行し、オンチェーンのバリデータネットワークアドレスを設定し、コンセンサスキーをローテーションします。
2. オーナーは自身のAptosコインをステークとして預け入れるか、ステーキングサービスから資金を割り当ててもらいます。ステークは必要な最小額以上である必要があります。
3. **ステークプールがアクティブになるまで、バリデータノードは同期できません。**
4. オペレーターはバリデーションを行い、報酬を得ます。
5. ステークプールは自動的に固定期間（Aptosガバナンスによって設定）ロックアップされ、期限切れ時に自動的に更新されます。ロックアップ期間が終了するまで、ステーク額を引き出すことはできません。[stake.move#L728](https://github.com/aptos-labs/aptos-core/blob/00a234cc233b01f1a7e1680f81b72214a7af91a9/aptos-move/framework/aptos-framework/sources/stake.move#L728)を参照してください。
6. オペレーターは、バリデータがアクティブになる前に新しいエポックが開始するのを待つ必要があります。

<Callout type="info">
バリデータセットへの参加方法の詳細な手順については、[バリデータセットへの参加](../nodes/validator-node/connect-nodes/connect-to-aptos-network.mdx#join-the-validator-set)を参照してください。
</Callout>

### 最小および最大ステーク

バリデータセットに参加するには、必要な最小額をステークする必要があります。また、最大ステーク額までしかステークできません。現在の必要最小ステーク額は100万APTトークンで、最大は5,000万APTトークンです。

バリデータセットに参加した後、現在のステーク額が許可された最大ステーク額を超えた場合（例えば、報酬がステーク額に追加された場合）、投票力と報酬は現在のステーク額ではなく、許可された最大ステーク額のみを使用して計算されます。

オーナーはステークの一部を引き出して、残高を必要最小額未満にすることができます。その場合、次のエポックが開始するとステークプールはバリデータセットから削除されます。

### 自動ロックアップ期間

バリデータセットに参加すると、ステークは自動的にAptosガバナンスによって設定された固定期間ロックアップされます。

### 自動ロックアップ更新

ロックアップ期間が終了すると、バリデーションを継続し報酬を受け取れるように自動的に更新されます。

### ステークのロック解除

いつでもステークのロック解除を要求できます。ただし、現在のロックアップが期限切れになるまで、ステークは引き出し可能になりません。これは最大でも固定ロックアップ期間と同じ長さです。引き出し可能になるまでの間、ステークに対する報酬は継続して獲得できます。

元本は以下のいずれかのアクションが発生した時に更新されます：

1. オペレーターが[手数料のロック解除を要求](../nodes/validator-node/connect-nodes/staking-pool-operations.mdx#requesting-commission)
2. ステーカー（オーナー）が資金を引き出す
3. ステーカー（オーナー）がオペレーターを切り替える

ステーカーがステークをロック解除すると、手数料のロック解除もトリガーされます。獲得したステーキング報酬に対する手数料の全額がロック解除されます。これはロック解除されたステーク額に比例するものではありません。手数料は、ロックアップ終了後に`request commission`が2回目に呼び出されるか、ステーカーがロック解除されたステークを引き出す（配布する）時にオペレーターに配布されます。

### ロックアップのリセット

ロックアップ期間が終了すると、ネットワークによって自動的に更新されます。ただし、オーナーは明示的にロックアップをリセットすることができます。

<Callout type="info">
ロックアップ期間は、Aptos Labsのような特別な主体ではなく、Aptosコミュニティメンバーが投票する規約、つまりAptosガバナンスによって決定されます。
</Callout>

## エポック

Aptosブロックチェーンにおけるエポックは、バリデータによって一定数のブロックが投票され、バリデータセットが更新され、バリデータに報酬が配布される、秒単位で定義された期間です。

<Callout type="info">
Aptosメインネットのエポックは7200秒（2時間）に設定されています。
</Callout>

### エポック開始時のトリガー

<Callout type="info">
完全なコードについては、[`stake.move`のエポック境界でのトリガーセクション](https://github.com/aptos-labs/aptos-core/blob/256618470f2ad7d89757263fbdbae38ac7085317/aptos-move/framework/aptos-framework/sources/stake.move#L1036)を参照してください。
</Callout>

各エポックの開始時に、以下の主要なイベントがトリガーされます：

- アクティブ待ちのバリデータをアクティブなバリデータセットに追加し、非アクティブ待ちのバリデータをアクティブなバリデータセットから削除することで、バリデータセットを更新します。
- アクティブ待ちのステークをアクティブなステークに、非アクティブ待ちのステークを非アクティブなステークに移行します。
- この新しいエポックでのステーキングプールの投票力は、アクティブなステークの合計に更新されます。
- 次のエポックでもバリデータセットに残るバリデータのロックアップを自動的に更新します。
- バリデータセット内の各バリデータの投票力は、対応するステーキングプールの投票力に更新されます。
- 前のエポックに参加したバリデータに報酬が配布されます。

## 報酬

ステーキングの報酬は以下を使用して計算されます：

1. 年率利回り（APY）である`rewards_rate`。つまり、報酬は現在のステーク額に対して複利として発生します。
2. ステーク額
3. Aptosガバナンスにおけるプロポーザーとしてのパフォーマンス

<Callout type="info">
`rewards_rate`はAptosガバナンスによって設定されます。また、[Aptosブロックチェーンでのバリデーション](#validation-on-the-aptos-blockchain)も参照してください。
</Callout>

### 報酬の計算式

以下はバリデータへの報酬を計算する式です：
