 import { Callout, FileTree } from "nextra/components";

# 本地模拟、基准测试与气体分析

## 概述
前面的教程演示了如何使用各种 CLI 命令部署和与 Move 合约交互。

默认情况下，这些命令将交易发送到远程全节点进行模拟和执行。
你可以通过附加以下命令行选项之一来覆盖此行为，并在本地模拟交易：
- `--local`：在不进行任何进一步测量或分析的情况下在本地模拟交易。
- `--benchmark`：基准测试交易并报告运行时间。
- `--profile-gas`：对交易进行气体分析以获取详细的气体使用情况。

这些附加选项可以与以下 CLI 命令组合使用：
- `aptos move run`
- `aptos move run-script`
- `aptos move publish`

另外，如果你有兴趣重放过去的交易，请查看[本教程](../replay-past-transactions.mdx)。

<Callout type="info" emoji="ℹ️">
本地模拟不会对链上状态产生任何影响。
</Callout>

## 部署示例合约
为了演示，我们将继续使用 [`hello_blockchain`](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/move-examples/hello_blockchain) 包作为示例。

首先，将包发布到开发网或测试网（如果你还没有这样做）。

切换到包目录。
```bash filename="Terminal"
cd aptos-move/move-examples/hello_blockchain
```

然后使用以下命令发布包。
```bash filename="Terminal"
aptos move publish --named-addresses hello_blockchain=default --assume-yes
```

<details>
<summary>输出</summary>
```bash
{
  "Result": {
    "transaction_hash": "0xe4ae0ec4ea3474b2123838885b04d7f4b046c174d14d7dc1c56916f2eb553bcf",
    "gas_used": 1118,
    "gas_unit_price": 100,
    "sender": "dbcbe741d003a7369d87ec8717afb5df425977106497052f96f4e236372f7dd5",
    "sequence_number": 5,
    "success": true,
    "timestamp_us": 1713914742422749,
    "version": 1033819503,
    "vm_status": "Executed successfully"
  }
}
```
</details>

请注意，你需要正确设置 CLI 配置文件并正确绑定命名地址。有关更多详细信息，请参阅 [CLI 配置](../setup-cli.mdx)。

<Callout type="info" emoji="ℹ️">
注意：将包发布到开发网/测试网只是为本地模拟设置舞台的一种方式，并不是唯一的方式。
你也可以使用本地节点，或者模拟不需要先发布代码的交易，例如脚本，甚至是包发布交易本身。
</Callout>

## 本地模拟
接下来，使用附加命令行选项 `--local` 执行入口函数 `message::set_message`，这将本地执行交易，而不进行任何进一步的测量或分析。
```bash filename="Terminal"
aptos move run --function-id 'default::message::set_message' --args 'string:abc' --local
```

<details>
<summary>输出</summary>
```bash
正在本地模拟交易...
{
  "Result": {
    "transaction_hash": "0x5aab20980688185eed2c9a27bab624c84b8b8117241cd4a367ba2a012069f57b",
    "gas_used": 441,
    "gas_unit_price": 100,
    "sender": "dbcbe741d003a7369d87ec8717afb5df425977106497052f96f4e236372f7dd5",
    "success": true,
    "version": 1033887414,
    "vm_status": "status EXECUTED of type Execution"
  }
}
```
</details>
<Callout type="info" emoji="ℹ️">
本地和远程模拟应产生相同的结果。
</Callout>

## 基准测试
要测量交易的运行时间，请使用 `--benchmark` 选项。

```bash filename="Terminal"
aptos move run --function-id 'default::message::set_message' --args 'string:abc' --benchmark
```

<details>
<summary>输出</summary>
```bash
正在本地基准测试交易...
运行时间（冷代码缓存）：985.141µs
运行时间（热代码缓存）：848.159µs
{
  "Result": {
    "transaction_hash": "0xa2fe548d37f12ee79df13e70fdd8212e37074c1b080b89b7d92e82550684ecdb",
    "gas_used": 441,
    "gas_unit_price": 100,
    "sender": "dbcbe741d003a7369d87ec8717afb5df425977106497052f96f4e236372f7dd5",
    "success": true,
    "version": 1033936831,
    "vm_status": "status EXECUTED of type Execution"
  }
}
```
</details>

值得注意的是，这些运行时间仅作为信息参考，因为它们取决于你的本地机器的规格，并可能受到噪声或其他随机因素的影响。

**如果你打算优化你的合约，应该根据气体分析结果来做出决策。**

<Callout type="info" emoji="ℹ️">
为了最小化测量误差，基准测试工具会多次执行相同的交易。因此，基准测试任务可能需要一段时间才能完成。
</Callout>

## 气体分析
Aptos 气体分析器是一个强大的工具，可以帮助你了解 Aptos 交易的气体使用情况。一旦激活，它将使用仪器化的虚拟机模拟交易，并生成基于 Web 的报告。

气体分析器还可以作为调试器，因为报告还包括完整的执行跟踪。

### 使用气体分析器
气体分析器可以通过附加 `--profile-gas` 选项来调用。

```bash filename="Terminal"
aptos move run --function-id 'default::message::set_message' --args 'string:abc' --profile-gas
```

<details>
<summary>输出</summary>
```bash
正在使用气体分析器本地模拟交易...
气体报告已保存到 gas-profiling/txn-d0bc3422-0xdbcb-message-set_message。
{
  "Result": {
    "transaction_hash": "0xd0bc342232f14a6a7d2d45251719aee45373bdb53f68403cfc6dc6062c74fa9e",
    "gas_used": 441,
    "gas_unit_price": 100,
    "sender": "dbcbe741d003a7369d87ec8717afb5df425977106497052f96f4e236372f7dd5",
    "success": true,
    "version": 1034003962,
    "vm_status": "status EXECUTED of type Execution"
  }
}
```
</details>

然后你可以在目录 `gas-profiling` 中找到生成的气体报告：

<FileTree>
  <FileTree.Folder name="hello_blockchain" defaultOpen>
    <FileTree.File name="Move.toml" />
    <FileTree.Folder name="sources" />
    <FileTree.Folder name="gas-profiling" defaultOpen>
      <FileTree.Folder name="txn-XXXXXXXX-0xXXXX-message-set_message" defaultOpen>
        <FileTree.Folder name="assets" defaultOpen />
        <FileTree.File name="index.html" />
      </FileTree.Folder>
    </FileTree.Folder>
  </FileTree.Folder>
</FileTree>

`index.html` 是报告的主页，可以使用你的 Web 浏览器查看。
[示例报告](/gas-profiling/sample-report/index.html)

### 理解气体报告

气体报告由三个部分组成，帮助你从不同的角度理解气体使用情况。

#### 火焰图

第一部分是以两种火焰图的形式可视化气体使用情况：一种用于执行和 IO，另一种用于存储。
我们需要两个图的原因是它们以不同的单位进行测量：一种以气体单位，另一种以 APT。

可以与图中的各种元素进行交互。如果你将光标悬停在某个项目上，它将显示精确的成本和百分比。
![gas-profiling-flamegraph-0.png](/docs/gas-profiling-flamegraph-0.png)

如果你单击某个项目，可以放大它并更清楚地查看子项目。
你可以通过单击左上角的“重置缩放”按钮来重置视图。
![gas-profiling-flamegraph-1.png](/docs/gas-profiling-flamegraph-1.png)

右上角还有一个“搜索”按钮，可以匹配某些项目并突出显示它们。
![gas-profiling-flamegraph-2.png](/docs/gas-profiling-flamegraph-2.png)

#### 成本细分

第二部分是所有气体成本的详细细分。本部分中呈现的数据经过分类、汇总和排序。
如果你知道要查看哪些数字，这可能特别有帮助。

例如，以下表格显示了所有 Move 字节码指令/操作的执行成本。
这里的百分比是相对于所属类别的总成本（在这种情况下为 Exec + IO）。

![gas-profiling-cost-break-down-table.png](/docs/gas-profiling-cost-break-down-table.png)

#### 完整执行跟踪

气体报告的最后一部分是交易的完整执行跟踪，格式如下：

```text filename="示例执行跟踪"
    intrinsic                                                     2.76        85.12%
    dependencies                                                  0.0607      1.87%
        0xdbcb..::message                                         0.0607      1.87%
    0xdbcb..::message::set_message                                0.32416     10.00%
        create_ty                                                 0.0004      0.01%
        create_ty                                                 0.0004      0.01%
        create_ty                                                 0.0004      0.01%
        create_ty                                                 0.0004      0.01%
        create_ty                                                 0.0008      0.02%
        imm_borrow_loc                                            0.00022     0.01%
        call                                                      0.00441     0.14%
        0x1::signer::address_of                                   0.007534    0.23%
            create_ty                                             0.0008      0.02%
            move_loc                                              0.000441    0.01%
            call                                                  0.004043    0.12%
            0x1::signer::borrow_address                           0.000735    0.02%
            read_ref                                              0.001295    0.04%
            ret                                                   0.00022     0.01%
        st_loc                                                    0.000441    0.01%
        copy_loc                                                  0.000854    0.03%
        load<0xdbcb..::0xdbcb..::message::MessageHolder>          0.302385    9.33%
        exists_generic                                            0.000919    0.03%
        not                                                       0.000588    0.02%
        br_false                                                  0.000441    0.01%
        imm_borrow_loc                                            0.00022     0.01%
        move_loc                                                  0.000441    0.01%
        pack                                                      0.000955    0.03%
        move_to_generic                                           0.001838    0.06%
        branch                                                    0.000294    0.01%
        @28
        ret                                                       0.00022     0.01%
    ledger writes                                                 0.097756    3.01%
        transaction
        events
        state write ops                                           0.097756    3.01%
            create<0xdbcb..::0xdbcb..::message::MessageHolder>    0.097756    3.01%
```

左列列出了所有正在执行的 Move 指令和操作，每个缩进级别表示一个函数调用。

中间列表示与操作相关的气体成本。

还有一个特殊符号 `@number`，表示跳转到字节码中的特定位置（上面的片段中的 `@28`）。
这纯粹是信息性的，旨在帮助理解控制流。
