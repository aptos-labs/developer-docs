 import { Callout } from 'nextra/components'

# 多重签名治理教程

## 背景

本节基于 [JSON 参数教程](arguments-in-json-tutorial.mdx)。如果你还没有完成该教程，请先完成它。

本教程同样引用了 [`CliArgs` 示例包](https://github.com/aptos-labs/aptos-core/tree/main/aptos-move/move-examples/cli_args)。

<Callout type="info" emoji="ℹ️">
如果你想跟随学习，请先完成 [JSON 参数](arguments-in-json-tutorial.mdx)教程的步骤！
</Callout>

在这个示例中，Ace 和 Bee 将从一个 2-of-2 的"多重签名 v2"账户（根据 [`multisig_account.move`](https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/multisig_account.move) 的链上多重签名账户）进行治理操作。

## 账户创建

由于 Ace 的账户是在 [JSON 参数](arguments-in-json-tutorial.mdx)教程中创建的，现在开始为 Bee 也生成一个虚荣地址账户：

```bash filename="Terminal"
aptos key generate \
    --vanity-prefix 0xbee \
    --output-file bee.key
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "PublicKey Path": "bee.key.pub",
    "PrivateKey Path": "bee.key",
    "Account Address:": "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc"
  }
}
```

</details>

<Callout type="info" emoji="ℹ️">
确切的账户地址在每次运行时应有所不同，但虚荣前缀不应改变。
</Callout>

将 Bee 的地址存储在 shell 变量中，以便稍后可以内联调用：

```bash filename="Terminal"
# 你的确切地址应有所不同
bee_addr=0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc
```

使用水龙头为 Bee 的账户提供资金：

```bash filename="Terminal"
aptos account fund-with-faucet --account $bee_addr
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": "Added 100000000 Octas to account beec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc"
}
```

</details>

现在 Ace 可以创建一个多重签名账户：

```bash filename="Terminal"
aptos multisig create \
    --additional-owners $bee_addr \
    --num-signatures-required 2 \
    --private-key-file ace.key \
    --assume-yes
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "multisig_address": "57478da34604655c68b1dcb89e4f4a9124b6c0ecc1c59a0931d58cc4e60ac5c5",
    "transaction_hash": "0x849cc756de2d3b57210f5d32ae4b5e7d1f80e5d376233885944b6f3cc2124a05",
    "gas_used": 1524,
    "gas_unit_price": 100,
    "sender": "acef1b9b7d4ab208b99fed60746d18dcd74865edb7eb3c3f1428233988e4ba46",
    "sequence_number": 5,
    "success": true,
    "timestamp_us": 1685078644186194,
    "version": 528428043,
    "vm_status": "Executed successfully"
  }
}
```

</details>

将多重签名地址存储在 shell 变量中：

```bash filename="Terminal"
# 你的地址应有所不同
multisig_addr=0x57478da34604655c68b1dcb89e4f4a9124b6c0ecc1c59a0931d58cc4e60ac5c5
```

## 检查多重签名账户

使用各种 [`multisig_account.move` 视图函数](https://github.com/aptos-labs/aptos-core/blob/9fa0102c3e474d99ea35a0a85c6893604be41611/aptos-move/framework/aptos-framework/sources/multisig_account.move#L237) 来检查多重签名账户：

```bash filename="所需签名数量"
aptos move view \
    --function-id 0x1::multisig_account::num_signatures_required \
    --args \
        address:"$multisig_addr"
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": [
    "2"
  ]
}
```

</details>

```bash filename="所有者"
aptos move view \
    --function-id 0x1::multisig_account::owners \
    --args \
        address:"$multisig_addr"
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": [
    [
      "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
      "0xacef1b9b7d4ab208b99fed60746d18dcd74865edb7eb3c3f1428233988e4ba46"
    ]
  ]
}
```

</details>

```bash filename="最后解决的序列号"
aptos move view \
    --function-id 0x1::multisig_account::last_resolved_sequence_number \
    --args \
        address:"$multisig_addr"
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": [
    "0"
  ]
}
```

</details>

```bash filename="下一个序列号"
aptos move view \
    --function-id 0x1::multisig_account::next_sequence_number \
    --args \
        address:"$multisig_addr"
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": [
    "1"
  ]
}
```

</details>

## 发布包

Bee 可以提议从多重签名账户发布包：

```bash filename="提议发布"
aptos multisig create-transaction \
    --multisig-address $multisig_addr \
    --function-id 0x1::code::publish_package_txn \
    --args hex:"$(cat publication.json)" \
    --private-key-file bee.key \
    --assume-yes
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "transaction_hash": "0x0c9e107f5e7a7a4b3c0d4a0f2b5d6e8f9a8b7c6d5e4f3a2b1c0d9e8f7a6b5c4d3",
    "gas_used": 1524,
    "gas_unit_price": 100,
    "sender": "beec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
    "sequence_number": 1,
    "success": true,
    "timestamp_us": 1685078744186194,
    "version": 528428143,
    "vm_status": "Executed successfully"
  }
}
```

</details>

Ace 可以验证提议的交易：

```bash filename="验证提议"
aptos multisig verify-proposal \
    --multisig-address $multisig_addr \
    --function-id 0x1::code::publish_package_txn \
    --args hex:"$(cat publication.json)" \
    --sequence-number 1
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "Status": "Transaction match",
    "Multisig transaction": {
      "creation_time_secs": "1685078744",
      "creator": "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
      "payload": {
        "vec": [
          "0x01000000000000000200000000000000000000000000000000000000000000000000000000000000010663...(省略)"
        ]
      },
      "payload_hash": {
        "vec": []
      },
      "votes": {
        "data": [
          {
            "key": "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
            "value": true
          }
        ]
      }
    }
  }
}
```

</details>

Ace 批准交易：

```bash filename="批准交易"
aptos multisig approve \
    --multisig-address $multisig_addr \
    --sequence-number 1 \
    --private-key-file ace.key \
    --assume-yes
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "transaction_hash": "0x233427d95832234fa13dddad5e0b225d40168b4c2c6b84f5255eecc3e68401bf",
    "gas_used": 6,
    "gas_unit_price": 100,
    "sender": "acef1b9b7d4ab208b99fed60746d18dcd74865edb7eb3c3f1428233988e4ba46",
    "sequence_number": 6,
    "success": true,
    "timestamp_us": 1685078844186194,
    "version": 528428243,
    "vm_status": "Executed successfully"
  }
}
```

</details>

现在 Ace 或 Bee 都可以从多重签名账户执行发布交易，因为只有哈希存储在链上，所以需要传递完整的交易负载：

```bash filename="发布"
aptos multisig execute-with-payload \
    --multisig-address $multisig_addr \
    --json-file publication.json \
    --private-key-file bee.key \
    --max-gas 10000 \
    --assume-yes
```

<Callout type="info" emoji="ℹ️">
在解决 [#8304](https://github.com/aptos-labs/aptos-core/issues/8304) 之前，交易模拟器（用于估算气体成本）对多重签名交易不起作用，所以你需要手动指定最大气体数量。
</Callout>

<details>
<summary>输出</summary>

在解决 [#8304](https://github.com/aptos-labs/aptos-core/issues/8304) 之前，如果只有负载哈希存储在链上，成功的多重签名发布交易执行会导致 API 错误，但可以使用浏览器手动验证交易。

</details>

## 执行治理参数交易

由于只有 Bee 对治理参数交易进行了投票（她在提议时隐含地批准了），所以交易还不能执行：

```bash filename="是否可以执行"
aptos move view \
    --function-id 0x1::multisig_account::can_be_executed \
    --args \
        address:"$multisig_addr" \
        String:2
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": [
    false
  ]
}
```

</details>

然而，在 Ace 投票之前，他验证存储在链上的负载是否与他期望的函数参数匹配：

```bash filename="验证交易提议"
aptos multisig verify-proposal \
    --multisig-address $multisig_addr \
    --function-id $multisig_addr::cli_args::set_vals \
    --type-args \
        0x1::account::Account \
        0x1::chain_id::ChainId \
    --args \
        u8:123 \
        "bool:[false, true, false, false]" \
        'address:[["0xace", "0xbee"], ["0xcad"], []]' \
    --sequence-number 2
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "Status": "Transaction match",
    "Multisig transaction": {
      "creation_time_secs": "1685078954",
      "creator": "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
      "payload": {
        "vec": [
          "0x0057478da34604655c68b1dcb89e4f4a9124b6c0ecc1c59a0931d58cc4e60ac5c508636c695f61726773087365745f76616c7302070000000000000000000000000000000000000000000000000000000000000001076163636f756e74074163636f756e740007000000000000000000000000000000000000000000000000000000000000000108636861696e5f696407436861696e49640003017b0504000100006403020000000000000000000000000000000000000000000000000000000000000ace0000000000000000000000000000000000000000000000000000000000000bee010000000000000000000000000000000000000000000000000000000000000cad00"
        ]
      },
      "payload_hash": {
        "vec": []
      },
      "votes": {
        "data": [
          {
            "key": "0xbeec980219d246581cef5166dc6ba5fb1e090c7a7786a5176d111a9029b16ddc",
            "value": true
          }
        ]
      }
    }
  }
}
```

</details>

注意，如果他修改了任何一个参数，验证都会失败：

```bash filename="修改 u8 后的失败交易验证"
aptos multisig verify-proposal \
    --multisig-address $multisig_addr \
    --function-id $multisig_addr::cli_args::set_vals \
    --type-args \
        0x1::account::Account \
        0x1::chain_id::ChainId \
    --args \
        u8:200 \
        "bool:[false, true, false, false]" \
        'address:[["0xace", "0xbee"], ["0xcad"], []]' \
    --sequence-number 2
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Error": "Unexpected error: Transaction mismatch: The transaction you provided has a payload hash of 0xe494b0072d6f940317344967cf0e818c80082375833708c773b0275f3ad07e51, but the on-chain transaction proposal you specified has a payload hash of 0x070ed7c3f812f25f585461305d507b96a4e756f784e01c8c59901871267a1580. For more info, see https://aptos.dev/move/move-on-aptos/cli#multisig-governance"
}
```

</details>

Ace 批准交易：

```bash filename="批准交易"
aptos multisig approve \
    --multisig-address $multisig_addr \
    --sequence-number 2 \
    --private-key-file ace.key \
    --assume-yes
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "transaction_hash": "0x233427d95832234fa13dddad5e0b225d40168b4c2c6b84f5255eecc3e68401bf",
    "gas_used": 6,
    "gas_unit_price": 100,
    "sender": "acef1b9b7d4ab208b99fed60746d18dcd74865edb7eb3c3f1428233988e4ba46",
    "sequence_number": 7,
    "success": true,
    "timestamp_us": 1685080266378400,
    "version": 528439883,
    "vm_status": "Executed successfully"
  }
}
```

</details>

由于负载已存储在链上，执行待处理交易时不需要提供它：

```bash filename="执行"
aptos multisig execute \
    --multisig-address $multisig_addr \
    --private-key-file ace.key \
    --max-gas 10000 \
    --assume-yes
```

<details>
<summary>输出</summary>

```bash filename="Terminal"
{
  "Result": {
    "transaction_hash": "0xbc99f929708a1058b223aa880d04607a78ebe503367ec4dab23af4a3bdb541b2",
    "gas_used": 505,
    "gas_unit_price": 100,
    "sender": "acef1b9b7d4ab208b99fed60746d18dcd74865edb7eb3c3f1428233988e4ba46",
    "sequence_number": 8,
    "success": true,
    "timestamp_us": 1685080344045461,
    "version": 528440423,
    "vm_status": "Executed successfully"
  }
}
```

</details>